<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hot List</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #7eb8ff;
      --primary-dark: #5a9fe8;
      --danger: #ff5252;
      --success: #4caf50;
      --bg: #141416;
      --bg2: #1c1c1f;
      --surface: #222226;
      --surface2: #2a2a2e;
      --border: #38383f;
      --text: #e8e8f0;
      --text-muted: #888899;
      --radius: 12px;
      --shadow: 0 2px 20px rgba(0,0,0,0.45);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== */
    #loginScreen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 24px; gap: 24px;
    }
    .login-title {
      font-size: 3rem; font-weight: 800; letter-spacing: 0.06em;
      background: linear-gradient(135deg, #ff9a00, #ff6a00, #ff4e00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .login-subtitle { font-size: 0.95rem; color: var(--text-muted); text-align: center; line-height: 1.6; }
    .btn-google {
      display: flex; align-items: center; gap: 12px; padding: 14px 28px;
      background: #fff; color: #333; border: none; border-radius: 12px;
      font-size: 1rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3); transition: transform 0.15s;
    }
    .btn-google:active { transform: scale(0.97); }
    .btn-google img { width: 22px; height: 22px; }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background: var(--bg2); color: #fff; padding: 12px 16px;
      display: grid; grid-template-columns: 1fr auto auto;
      align-items: center; gap: 8px; position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border); box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }
    .header-title {
      grid-column: 1 / -1; text-align: center; font-size: 2.55rem; font-weight: 800;
      letter-spacing: 0.06em;
      background: linear-gradient(135deg, #ff9a00, #ff6a00, #ff4e00);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      line-height: 1.2; padding: 2px 0;
    }
    .header-row {
      grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .header-left { display: flex; align-items: center; gap: 8px; }
    .header-count {
      background: rgba(126,184,255,0.12); border: 1px solid rgba(126,184,255,0.3);
      border-radius: 20px; padding: 3px 10px; font-size: 0.85rem; color: var(--primary); font-weight: 600;
    }
    .user-avatar {
      width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
      border: 2px solid var(--border); object-fit: cover;
    }
    .user-name { font-size: 0.8rem; color: var(--text-muted); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn-add-header {
      display: inline-flex; align-items: center; gap: 5px; padding: 7px 14px;
      background: linear-gradient(135deg, #f7971e, #ff4e50); color: #fff; border: none;
      border-radius: 22px; font-size: 0.9rem; font-weight: 700; cursor: pointer;
      box-shadow: 0 2px 10px rgba(255,78,80,0.35); transition: transform 0.15s; white-space: nowrap;
    }
    .btn-add-header:active { transform: scale(0.96); }

    /* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ ===== */
    .toolbar {
      padding: 12px 14px; display: flex; gap: 8px; flex-wrap: wrap;
      align-items: center; background: var(--bg2); border-bottom: 1px solid var(--border);
    }
    .toolbar input[type="text"] {
      flex: 1; min-width: 140px; padding: 13px 14px; border: 2px solid var(--border);
      border-radius: 12px; font-size: 1.05rem; outline: none; transition: border-color 0.2s;
      background: var(--surface); color: var(--text);
    }
    .toolbar input[type="text"]::placeholder { color: var(--text-muted); }
    .toolbar input[type="text"]:focus { border-color: var(--primary); }
    .toolbar select {
      padding: 13px 10px; border: 2px solid var(--border); border-radius: 12px;
      font-size: 1rem; background: var(--surface); color: var(--text); outline: none;
    }

    /* ===== ãƒœã‚¿ãƒ³å…±é€š ===== */
    .btn {
      display: inline-flex; align-items: center; gap: 4px; padding: 10px 16px;
      border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600;
      cursor: pointer; transition: opacity 0.15s, transform 0.1s; white-space: nowrap;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #1a1a2e; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-outline { background: rgba(126,184,255,0.07); color: var(--primary); border: 2px solid rgba(126,184,255,0.5); }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }

    /* ===== ã‚«ãƒ¼ãƒ‰ ===== */
    .list-container { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .person-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    .card-header { padding: 13px 14px 11px; display: flex; align-items: center; gap: 11px; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
    .avatar { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.15rem; font-weight: 700; color: #fff; flex-shrink: 0; }
    .card-info { flex: 1; min-width: 0; }
    .card-name { font-size: 1.05rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .card-sub { font-size: 0.83rem; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
    .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 26px; padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 800; letter-spacing: 0.04em; }
    .trust-S { background: linear-gradient(135deg,#1b4d28,#2a6b38); color: #6ef093; border: 1px solid #3a8a4a; box-shadow: 0 0 6px rgba(110,240,147,0.2); }
    .trust-A { background: linear-gradient(135deg,#0e1e40,#1a3060); color: #6ab4fa; border: 1px solid #2a50a0; box-shadow: 0 0 6px rgba(100,180,250,0.2); }
    .trust-B { background: linear-gradient(135deg,#2e1e00,#4a3200); color: #ffd04a; border: 1px solid #6a4800; box-shadow: 0 0 6px rgba(255,200,50,0.2); }
    .trust-C { background: linear-gradient(135deg,#2e0808,#4a1010); color: #ff7a70; border: 1px solid #7a2020; }
    .trust-D { background: linear-gradient(135deg,#1a1a22,#252530); color: #888899; border: 1px solid #3a3a4a; }
    .type-P { background: #2a1a20; color: #f48fb1; border: 1px solid #4a2a35; }
    .type-C { background: #161a28; color: #9fa8da; border: 1px solid #28304a; }
    .type-A { background: #0e1e1c; color: #80cbc4; border: 1px solid #1e3835; }
    .type-S { background: #201800; color: #ffcc80; border: 1px solid #3a2a00; }
    .pos-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; letter-spacing: 0.06em; vertical-align: middle; }
    .pos-up   { background: rgba(79,200,120,0.15); color: #4fc878; border: 1px solid rgba(79,200,120,0.4); }
    .pos-down { background: rgba(255,82,82,0.15);  color: #ff7070; border: 1px solid rgba(255,82,82,0.4); }
    .pos-eq   { background: rgba(150,150,200,0.15); color: #aab0cc; border: 1px solid rgba(150,150,200,0.4); }
    .chevron { font-size: 0.82rem; color: var(--text-muted); transition: transform 0.2s; }
    .chevron.open { transform: rotate(180deg); }

    /* ===== ã‚«ãƒ¼ãƒ‰è©³ç´° ===== */
    .card-detail { display: none; padding: 0 14px 14px; border-top: 1px solid var(--border); background: var(--surface2); }
    .card-detail.open { display: block; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .detail-item.full { grid-column: 1 / -1; }
    .detail-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
    .detail-value { font-size: 0.92rem; font-weight: 500; color: var(--text); word-break: break-all; }
    .detail-value a { color: var(--primary); text-decoration: none; }
    .card-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }

    /* ===== ãƒã‚¤ãƒ©ã‚¤ãƒˆ ===== */
    .card-highlight1 { border: 1.5px solid rgba(100,200,255,0.5) !important; animation: glow1 2.5s ease-in-out infinite; }
    @keyframes glow1 { 0%,100%{box-shadow:0 0 8px rgba(100,200,255,0.15),var(--shadow);}50%{box-shadow:0 0 18px rgba(100,200,255,0.35),var(--shadow);} }
    .card-highlight2 { border: 1.5px solid rgba(255,165,0,0.7) !important; animation: glow2 1.8s ease-in-out infinite; }
    @keyframes glow2 { 0%,100%{box-shadow:0 0 10px rgba(255,140,0,0.25),var(--shadow);}50%{box-shadow:0 0 26px rgba(255,140,0,0.55),0 0 6px rgba(255,200,0,0.3),var(--shadow);} }

    /* ===== æœ€çµ‚é€£çµ¡ãƒãƒƒã‚¸ ===== */
    .lc-badge { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: 700; }
    .lc-fresh  { background: rgba(76,175,80,0.15);   color: #69f08a; border: 1px solid rgba(76,175,80,0.4); }
    .lc-recent { background: rgba(79,142,247,0.15);  color: #7eb8ff; border: 1px solid rgba(79,142,247,0.4); }
    .lc-mid    { background: rgba(255,179,0,0.15);   color: #ffd04a; border: 1px solid rgba(255,179,0,0.4); }
    .lc-old    { background: rgba(255,82,82,0.15);   color: #ff8a80; border: 1px solid rgba(255,82,82,0.4); }
    .lc-dead   { background: rgba(100,100,120,0.15); color: #888899; border: 1px solid rgba(100,100,120,0.4); }

    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 200; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 12px 12px 60px; }
    .modal-overlay.open { display: block; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); width: 100%; max-width: 520px; padding: 20px; box-shadow: 0 8px 40px rgba(0,0,0,0.6); margin: 0 auto; }
    .modal-title { font-size: 1.08rem; font-weight: 700; color: var(--text); margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--surface); z-index: 1; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-muted); padding: 4px 8px; line-height: 1; border-radius: 6px; }

    /* ===== ãƒ•ã‚©ãƒ¼ãƒ  ===== */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group.full { grid-column: 1 / -1; }
    label { font-size: 0.88rem; font-weight: 600; color: var(--text-muted); }
    input, select, textarea { width: 100%; padding: 13px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.02rem; font-family: inherit; outline: none; transition: border-color 0.2s; background: var(--bg2); color: var(--text); }
    input::placeholder { color: var(--text-muted); }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    textarea { resize: vertical; min-height: 78px; }
    select option { background: var(--surface); color: var(--text); }
    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border); }

    /* ===== å…±æœ‰ãƒ‘ãƒãƒ« ===== */
    .share-section { padding: 4px 0; }
    .share-section-title { font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 6px; }
    .share-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.55; margin-bottom: 4px; }
    .share-divider { height: 1px; background: var(--border); margin: 14px 0; }
    .share-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }

    /* ===== å…±æœ‰æ¨©é™ãƒªã‚¹ãƒˆ ===== */
    .share-member-list { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    .share-member-item { display: flex; align-items: center; justify-content: space-between; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.85rem; }
    .share-member-email { color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .share-member-owner { font-size: 0.75rem; color: var(--primary); font-weight: 600; }

    /* ===== ç©ºçŠ¶æ…‹ ===== */
    .empty-state { text-align: center; padding: 60px 24px; color: var(--text-muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.95rem; margin-top: 8px; }

    /* ===== Toast ===== */
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 11px 22px; border-radius: 24px; font-size: 0.92rem; z-index: 300; opacity: 0; transition: opacity 0.25s, transform 0.25s; white-space: nowrap; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
    .loading { display: flex; align-items: center; justify-content: center; min-height: 200px; color: var(--text-muted); font-size: 0.9rem; gap: 10px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .fab { display: none; }

    @media (max-width: 480px) {
      .form-grid { grid-template-columns: 1fr; }
      .detail-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: 1; }
      .modal-overlay { padding: 8px 8px 70px; }
      .modal { padding: 14px; }
    }
  </style>
</head>
<body>

<!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="loginScreen">
  <div class="login-title">Hot List</div>
  <p class="login-subtitle">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦<br>ãƒ›ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†</p>
  <button class="btn-google" onclick="signInWithGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
  </button>
  <p style="font-size:0.78rem;color:var(--text-muted);margin-top:8px;">â€» ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</p>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ ===== -->
<div id="mainScreen" style="display:none;">
  <header>
    <div class="header-title">Hot List</div>
    <div class="header-row">
      <div class="header-left">
        <span class="header-count" id="countBadge">0äºº</span>
        <span class="user-name" id="userNameDisplay"></span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-outline btn-sm" onclick="openShareModal()">å…±æœ‰</button>
        <button class="btn-add-header" onclick="openAddModal()">ï¼‹ è¿½åŠ </button>
        <img id="userAvatar" class="user-avatar" src="" alt="" onclick="confirmSignOut()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" style="display:none;">
      </div>
    </div>
  </header>

  <div class="toolbar">
    <input type="text" id="searchInput" placeholder="åå‰ãƒ»ä»•äº‹ãƒ»é–¢ä¿‚æ€§ã§æ¤œç´¢" oninput="renderList()">
    <select id="filterTrust" onchange="renderList()">
      <option value="">ä¿¡ç”¨åº¦ å…¨ã¦</option>
      <option value="S">S ãƒ©ãƒ³ã‚¯</option>
      <option value="A">A ãƒ©ãƒ³ã‚¯</option>
      <option value="B">B ãƒ©ãƒ³ã‚¯</option>
      <option value="C">C ãƒ©ãƒ³ã‚¯</option>
      <option value="D">D ãƒ©ãƒ³ã‚¯</option>
    </select>
    <select id="filterType" onchange="renderList()">
      <option value="">ã‚¿ã‚¤ãƒ— å…¨ã¦</option>
      <option value="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼</option>
      <option value="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</option>
      <option value="ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼">ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</option>
      <option value="ã‚µãƒãƒ¼ã‚¿ãƒ¼">ã‚µãƒãƒ¼ã‚¿ãƒ¼</option>
    </select>
  </div>

  <div class="list-container" id="listContainer">
    <div class="loading"><div class="spinner"></div>èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<button class="fab">ï¼‹</button>
<div class="toast" id="toast"></div>

<!-- ===== è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">
      <span id="modalTitle">æ–°è¦è¿½åŠ </span>
      <button class="modal-close" onclick="closeEditModal()">âœ•</button>
    </div>
    <form id="personForm" onsubmit="savePerson(event)">
      <div class="form-grid">
        <div class="form-group full"><label>åå‰ *</label><input type="text" id="f_name" required placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ"></div>
        <div class="form-group">
          <label>å¹´é½¢</label>
          <select id="f_age">
            <option value="">-</option>
            <option value="18">18æ­³</option><option value="19">19æ­³</option><option value="20">20æ­³</option>
            <option value="21">21æ­³</option><option value="22">22æ­³</option><option value="23">23æ­³</option>
            <option value="24" selected>24æ­³</option><option value="25">25æ­³</option><option value="26">26æ­³</option>
            <option value="27">27æ­³</option><option value="28">28æ­³</option><option value="29">29æ­³</option>
            <option value="30">30æ­³</option><option value="31">31æ­³</option><option value="32">32æ­³</option>
            <option value="33">33æ­³</option><option value="34">34æ­³</option><option value="35">35æ­³</option>
            <option value="36">36æ­³</option><option value="37">37æ­³</option><option value="38">38æ­³</option>
            <option value="39">39æ­³</option><option value="40">40æ­³</option><option value="41">41æ­³</option>
            <option value="42">42æ­³</option><option value="43">43æ­³</option><option value="44">44æ­³</option>
            <option value="45">45æ­³</option><option value="46">46æ­³</option><option value="47">47æ­³</option>
            <option value="48">48æ­³</option><option value="49">49æ­³</option><option value="50">50æ­³</option>
          </select>
        </div>
        <div class="form-group"><label>æ€§åˆ¥</label><select id="f_gender"><option value="">-</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option><option value="ãã®ä»–">ãã®ä»–</option></select></div>
        <div class="form-group full"><label>ã‚¤ãƒ³ã‚¹ã‚¿ URL</label><input type="url" id="f_insta" placeholder="https://www.instagram.com/..."></div>
        <div class="form-group full"><label>é–¢ä¿‚æ€§</label><input type="text" id="f_relation" placeholder="ä¾‹ï¼šä¸­å­¦ã®é‡çƒéƒ¨ã®åŒç´šç”Ÿ"></div>
        <div class="form-group full"><label>ä»•äº‹ï¼ˆç¤¾åï¼‰</label><input type="text" id="f_job" placeholder="ä¾‹ï¼šå–¶æ¥­ / æ ªå¼ä¼šç¤¾ã€‡ã€‡"></div>
        <div class="form-group"><label>ä¿¡ç”¨åº¦</label><select id="f_trust"><option value="">-</option><option value="S">Sï¼ˆ100%ï¼‰</option><option value="A">Aï¼ˆ80%ä»¥ä¸Šï¼‰</option><option value="B">Bï¼ˆ50%ä»¥ä¸Šï¼‰</option><option value="C">Cï¼ˆãã‚Œä»¥ä¸‹ï¼‰</option><option value="D">Dï¼ˆå…¨ããªã—ï¼‰</option></select></div>
        <div class="form-group"><label>ç«‹å ´</label><select id="f_position"><option value="">-</option><option value="â†‘">â†‘ è‡ªåˆ†ãŒä¸Š</option><option value="â†“">â†“ è‡ªåˆ†ãŒä¸‹</option><option value="ãƒ¼">ãƒ¼ åŒã˜</option></select></div>
        <div class="form-group full"><label>ãƒ‹ãƒ¼ã‚º</label><input type="text" id="f_needs" placeholder="ä¾‹ï¼šãŠé‡‘ã‚’ç¨¼ããŸã„ã€ä»•äº‹ã‚’è¾ã‚ãŸã„"></div>
        <div class="form-group"><label>ç¾ä½æ‰€ï¼ˆéƒ½é“åºœçœŒï¼‰</label><input type="text" id="f_address" placeholder="ä¾‹ï¼šç¦å²¡"></div>
        <div class="form-group"><label>ç¾ä½æ‰€ï¼ˆå¸‚ï¼‰</label><input type="text" id="f_address_city" placeholder="ä¾‹ï¼šç¦å²¡å¸‚"></div>
        <div class="form-group"><label>å‡ºèº«åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰</label><input type="text" id="f_hometown" placeholder="ä¾‹ï¼šç¦å²¡"></div>
        <div class="form-group"><label>å‡ºèº«åœ°ï¼ˆå¸‚ï¼‰</label><input type="text" id="f_hometown_city" placeholder="ä¾‹ï¼šç­‘ç´«é‡å¸‚"></div>
        <div class="form-group"><label>ä½ã¾ã„</label><select id="f_living"><option value="">-</option><option value="ä¸€äººæš®ã‚‰ã—">ä¸€äººæš®ã‚‰ã—</option><option value="å®Ÿå®¶">å®Ÿå®¶</option><option value="åŒæ£²">åŒæ£²</option><option value="åŠåŒæ£²">åŠåŒæ£²</option><option value="ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹">ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹</option></select></div>
        <div class="form-group"><label>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</label><select id="f_partner"><option value="">-</option><option value="æœ‰ã‚Š">æœ‰ã‚Š</option><option value="ç„¡ã—">ç„¡ã—</option><option value="çµå©š">çµå©š</option><option value="å­ä¾›ã‚ã‚Š">å­ä¾›ã‚ã‚Š</option></select></div>
        <div class="form-group full"><label>ï¼”ã¤ã®ã‚¿ã‚¤ãƒ—</label><select id="f_type"><option value="">-</option><option value="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼</option><option value="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</option><option value="ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼">ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</option><option value="ã‚µãƒãƒ¼ã‚¿ãƒ¼">ã‚µãƒãƒ¼ã‚¿ãƒ¼</option></select></div>
        <div class="form-group full"><label>æœ€çµ‚é€£çµ¡æ—¥</label><select id="f_lastcontact"><option value="">-</option><option value="1é€±é–“ä»¥å†…">1é€±é–“ä»¥å†…</option><option value="1ãƒ¶æœˆä»¥å†…">1ãƒ¶æœˆä»¥å†…</option><option value="3ãƒ¶æœˆä»¥å†…">3ãƒ¶æœˆä»¥å†…</option><option value="åŠå¹´ä»¥å†…">åŠå¹´ä»¥å†…</option><option value="1å¹´ä»¥å†…">1å¹´ä»¥å†…</option><option value="3å¹´ä»¥ä¸Šå‰">3å¹´ä»¥ä¸Šå‰</option></select></div>
        <div class="form-group full"><label>å‚™è€ƒ</label><textarea id="f_memo" placeholder="è‡ªç”±è¨˜è¿°"></textarea></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-outline" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== å…±æœ‰ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="shareModal">
  <div class="modal">
    <div class="modal-title">
      <span>å…±æœ‰ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†</span>
      <button class="modal-close" onclick="closeShareModal()">âœ•</button>
    </div>

    <div class="share-section">
      <div class="share-section-title">è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã‚’å…±æœ‰ã™ã‚‹</div>
      <p class="share-desc">å…±æœ‰ã—ãŸã„ç›¸æ‰‹ã®Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ãŒè‡ªåˆ†ã®ãƒªã‚¹ãƒˆã‚’é–²è¦§ã§ãã¾ã™ã€‚</p>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input type="email" id="shareEmailInput" placeholder="ä¾‹ï¼šfriend@gmail.com" style="flex:1;font-size:0.92rem;padding:10px 12px;">
        <button class="btn btn-primary btn-sm" onclick="addShareMember()">è¿½åŠ </button>
      </div>
      <div class="share-member-list" id="shareMemberList"></div>
    </div>

    <div class="share-divider"></div>

    <div class="share-section">
      <div class="share-section-title">é–²è¦§ã§ãã‚‹ãƒªã‚¹ãƒˆ</div>
      <p class="share-desc">ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã§ã™ã€‚</p>
      <div id="sharedWithMeList" style="margin-top:8px;font-size:0.85rem;color:var(--text-muted);">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="share-divider"></div>

    <div class="share-section">
      <div class="share-section-title">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰</div>
      <div class="share-actions">
        <button class="btn btn-outline btn-sm" onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline btn-sm" style="cursor:pointer;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input type="file" accept=".json" style="display:none" onchange="importData(event)"></label>
      </div>
    </div>

    <div class="share-divider"></div>

    <div class="share-section">
      <div id="shareStats" style="font-size:0.82rem;color:var(--text-muted);"></div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" onclick="confirmSignOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button class="btn btn-danger btn-sm" onclick="clearAll()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <div class="modal-title">å‰Šé™¤ã®ç¢ºèª</div>
    <p id="deleteConfirmText" style="font-size:0.9rem;margin-bottom:16px;color:var(--text);"></p>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ===== Firebase SDK ===== -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// ===== Firebaseè¨­å®š =====
const firebaseConfig = {
  apiKey: "AIzaSyBHLz19p4wsSi043V0hhE-Crjwv6VBKBro",
  authDomain: "hotlist-21865.firebaseapp.com",
  projectId: "hotlist-21865",
  storageBucket: "hotlist-21865.firebasestorage.app",
  messagingSenderId: "565556414915",
  appId: "1:565556414915:web:f8c3489260e8d9d6e49576"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ===== çŠ¶æ…‹ =====
let currentUser = null;
let people = [];
let editingId = null;
let deleteTargetId = null;
let unsubscribeSnapshot = null;
let viewingUserId = null; // ä»–äººã®ãƒªã‚¹ãƒˆã‚’é–²è¦§ä¸­ã®UID
let viewingUserName = '';

const FIELDS = ['name','age','gender','insta','relation','job','trust','position','needs',
                'address','address_city','hometown','hometown_city','living','partner','type','lastcontact','memo'];

// ===== Googleãƒ­ã‚°ã‚¤ãƒ³ (Popupæ–¹å¼) =====
window.signInWithGoogle = async () => {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, provider);
  } catch(e) {
    console.error(e);
    if (e.code === 'auth/popup-blocked') {
      showToast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
    } else if (e.code === 'auth/popup-closed-by-user') {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‰ã˜ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
    } else {
      showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.code);
    }
  }
};

// ===== èªè¨¼çŠ¶æ…‹ç›£è¦– =====
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display = 'block';
    // ã‚¢ãƒã‚¿ãƒ¼
    if (user.photoURL) {
      const av = document.getElementById('userAvatar');
      av.src = user.photoURL;
      av.style.display = 'block';
    }
    document.getElementById('userNameDisplay').textContent = user.displayName || '';
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç™»éŒ²
    await setDoc(doc(db, 'users', user.uid), {
      email: user.email,
      displayName: user.displayName || '',
      photoURL: user.photoURL || '',
      updatedAt: serverTimestamp()
    }, { merge: true });
    // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
    loadMyList();
    // å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    loadSharedWithMe();
  } else {
    currentUser = null;
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainScreen').style.display = 'none';
    if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }
  }
});

// ===== è‡ªåˆ†ã®ãƒªã‚¹ãƒˆè³¼èª­ =====
function loadMyList(uid) {
  if (unsubscribeSnapshot) { unsubscribeSnapshot(); }
  const targetUid = uid || currentUser.uid;
  viewingUserId = targetUid;
  const colRef = collection(db, 'users', targetUid, 'people');
  unsubscribeSnapshot = onSnapshot(colRef, snapshot => {
    people = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    people.sort((a, b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    renderList();
  });
}

// ===== å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ =====
async function loadSharedWithMe() {
  if (!currentUser) return;
  const el = document.getElementById('sharedWithMeList');
  try {
    // è‡ªåˆ†ã®emailãŒ sharedWith ã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    const usersSnap = await getDocs(collection(db, 'users'));
    const shared = [];
    for (const userDoc of usersSnap.docs) {
      if (userDoc.id === currentUser.uid) continue;
      const shareDoc = await getDoc(doc(db, 'users', userDoc.id, 'settings', 'share'));
      if (shareDoc.exists()) {
        const sw = shareDoc.data().sharedWith || [];
        if (sw.includes(currentUser.email)) {
          shared.push({ uid: userDoc.id, name: userDoc.data().displayName || userDoc.data().email });
        }
      }
    }
    if (shared.length === 0) {
      el.textContent = 'ã¾ã å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
      return;
    }
    el.innerHTML = shared.map(s => `
      <div class="share-member-item" style="cursor:pointer;" onclick="switchToList('${s.uid}','${escHtml(s.name)}')">
        <span class="share-member-email">${escHtml(s.name)}</span>
        <span style="font-size:0.75rem;color:var(--primary);">é–²è¦§ã™ã‚‹ â†’</span>
      </div>`).join('');
  } catch(e) {
    el.textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}

// ===== ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ =====
window.switchToList = (uid, name) => {
  viewingUserName = name;
  closeShareModal();
  loadMyList(uid);
  showToast(`${name} ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºä¸­`);
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
  document.getElementById('userNameDisplay').textContent =
    uid === currentUser.uid ? (currentUser.displayName || '') : `${name} ã®ãƒªã‚¹ãƒˆ`;
};

// ===== è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã«æˆ»ã‚‹ =====
function backToMyList() {
  loadMyList(currentUser.uid);
  document.getElementById('userNameDisplay').textContent = currentUser.displayName || '';
  showToast('è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã«æˆ»ã‚Šã¾ã—ãŸ');
}
window.backToMyList = backToMyList;

// ===== å…±æœ‰ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† =====
window.addShareMember = async () => {
  const email = document.getElementById('shareEmailInput').value.trim().toLowerCase();
  if (!email || !email.includes('@')) { showToast('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (email === currentUser.email) { showToast('è‡ªåˆ†è‡ªèº«ã¯è¿½åŠ ã§ãã¾ã›ã‚“'); return; }
  try {
    const shareRef = doc(db, 'users', currentUser.uid, 'settings', 'share');
    const shareDoc = await getDoc(shareRef);
    const current = shareDoc.exists() ? (shareDoc.data().sharedWith || []) : [];
    if (current.includes(email)) { showToast('ã™ã§ã«è¿½åŠ æ¸ˆã¿ã§ã™'); return; }
    await setDoc(shareRef, { sharedWith: [...current, email] }, { merge: true });
    document.getElementById('shareEmailInput').value = '';
    showToast(`${email} ã«å…±æœ‰ã—ã¾ã—ãŸ`);
    renderShareMemberList();
  } catch(e) {
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

async function renderShareMemberList() {
  if (!currentUser) return;
  const el = document.getElementById('shareMemberList');
  const shareDoc = await getDoc(doc(db, 'users', currentUser.uid, 'settings', 'share'));
  const members = shareDoc.exists() ? (shareDoc.data().sharedWith || []) : [];
  if (members.length === 0) {
    el.innerHTML = '<div style="font-size:0.82rem;color:var(--text-muted);margin-top:6px;">ã¾ã å…±æœ‰ã—ã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  el.innerHTML = members.map(email => `
    <div class="share-member-item">
      <span class="share-member-email">${escHtml(email)}</span>
      <button class="btn btn-danger btn-sm" onclick="removeShareMember('${escHtml(email)}')">å‰Šé™¤</button>
    </div>`).join('');
}

window.removeShareMember = async (email) => {
  try {
    const shareRef = doc(db, 'users', currentUser.uid, 'settings', 'share');
    const shareDoc = await getDoc(shareRef);
    const current = shareDoc.exists() ? (shareDoc.data().sharedWith || []) : [];
    await setDoc(shareRef, { sharedWith: current.filter(e => e !== email) }, { merge: true });
    showToast(`${email} ã®å…±æœ‰ã‚’è§£é™¤ã—ã¾ã—ãŸ`);
    renderShareMemberList();
  } catch(e) {
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

// ===== ã‚«ãƒ©ãƒ¼ =====
const COLORS_MALE   = ['#0097a7','#00838f','#006064','#00acc1','#26c6da','#00bcd4','#0288d1','#0277bd'];
const COLORS_FEMALE = ['#e91e8c','#c2185b','#ad1457','#f06292','#ec407a','#e91e63','#d81b60','#f48fb1'];
const COLORS_OTHER  = ['#7e57c2','#5e35b1','#4527a0','#6a1b9a','#7b1fa2','#8e24aa','#9c27b0','#ab47bc'];
function getColor(name, gender) {
  let h = 0;
  for (let c of (name||'A')) h = (h*31 + c.charCodeAt(0)) & 0xff;
  if (gender === 'å¥³æ€§') return COLORS_FEMALE[h % COLORS_FEMALE.length];
  if (gender === 'ç”·æ€§') return COLORS_MALE[h % COLORS_MALE.length];
  return COLORS_OTHER[h % COLORS_OTHER.length];
}

const TYPE_SHORT = { 'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼':'P','ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼':'C','ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼':'A','ã‚µãƒãƒ¼ã‚¿ãƒ¼':'S' };

function positionLabel(p) {
  if (p==='â†‘') return '<span class="pos-badge pos-up">â†‘</span>';
  if (p==='â†“') return '<span class="pos-badge pos-down">â†“</span>';
  if (p==='ãƒ¼') return '<span class="pos-badge pos-eq">ãƒ¼</span>';
  return '';
}

function lastcontactClass(v) {
  if (v==='1é€±é–“ä»¥å†…') return 'fresh';
  if (v==='1ãƒ¶æœˆä»¥å†…') return 'recent';
  if (v==='3ãƒ¶æœˆä»¥å†…'||v==='åŠå¹´ä»¥å†…') return 'mid';
  if (v==='1å¹´ä»¥å†…') return 'old';
  return 'dead';
}

function getHighlightClass(p) {
  const age = parseInt(p.age,10);
  const ageOk = !isNaN(age) && age>=20 && age<=26;
  const livingOk = p.living==='ä¸€äººæš®ã‚‰ã—';
  const addressOk = (p.address||'').includes('ç¦å²¡');
  const hometownOk = (p.hometown||'').includes('ç¦å²¡');
  if (!ageOk||!livingOk||!addressOk||!hometownOk) return '';
  if ((p.trust==='S'||p.trust==='A') && p.position==='â†‘') return 'card-highlight2';
  return 'card-highlight1';
}

// ===== ãƒªã‚¹ãƒˆæç”» =====
window.renderList = function() {
  const q   = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const ft  = document.getElementById('filterTrust')?.value||'';
  const ftp = document.getElementById('filterType')?.value||'';
  const isReadOnly = viewingUserId !== currentUser?.uid;

  const filtered = people.filter(p => {
    const matchQ = !q || [p.name,p.job,p.relation,p.needs,p.address,p.address_city,p.hometown,p.hometown_city,p.memo]
      .some(v=>(v||'').toLowerCase().includes(q));
    const matchT  = !ft  || p.trust===ft;
    const matchTP = !ftp || p.type===ftp;
    return matchQ && matchT && matchTP;
  });

  document.getElementById('countBadge').textContent = `${filtered.length}äºº`;
  const container = document.getElementById('listContainer');

  if (filtered.length===0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‹</div>
      <strong>${people.length===0?'ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“':'è©²å½“è€…ãªã—'}</strong>
      <p>${people.length===0?'å³ä¸Šã®ã€Œï¼‹ è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„':'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚„æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„'}</p>
      ${isReadOnly?'<button class="btn btn-outline btn-sm" style="margin-top:16px;" onclick="backToMyList()">â† è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button>':''}
    </div>`;
    return;
  }

  container.innerHTML = (isReadOnly ? `<div style="padding:10px 0 4px;"><button class="btn btn-outline btn-sm" onclick="backToMyList()">â† è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button></div>` : '')
    + filtered.map(p => {
    const initial = (p.name||'?')[0];
    const color = getColor(p.name, p.gender);
    const typeShort = TYPE_SHORT[p.type]||'';
    const typeCls = typeShort ? `type-${typeShort}` : '';
    const hlClass = getHighlightClass(p);
    const addressFull = [p.address,p.address_city].filter(Boolean).join(' ');
    const hometownFull = [p.hometown,p.hometown_city].filter(Boolean).join(' ');
    const canEdit = !isReadOnly;
    return `<div class="person-card ${hlClass}" id="card-${p.id}">
      <div class="card-header" onclick="toggleCard('${p.id}')">
        <div class="avatar" style="background:${color}">${initial}</div>
        <div class="card-info">
          <div class="card-name">${escHtml(p.name)}${p.position?`<span>${positionLabel(p.position)}</span>`:''}</div>
          <div class="card-sub">${[p.age?p.age+'æ­³':'',p.gender,p.job].filter(Boolean).join(' Â· ')}</div>
          <div class="card-sub">${p.relation||''}</div>
        </div>
        <div class="card-badges">
          ${p.trust?`<span class="badge trust-${p.trust}">${p.trust}</span>`:''}
          ${typeShort?`<span class="badge ${typeCls}">${p.type}</span>`:''}
          <span class="chevron" id="chev-${p.id}">â–¼</span>
        </div>
      </div>
      <div class="card-detail" id="detail-${p.id}">
        <div class="detail-grid">
          ${p.needs?detailItem('ãƒ‹ãƒ¼ã‚º',escHtml(p.needs)):''}
          ${addressFull?detailItem('ç¾ä½æ‰€',escHtml(addressFull)):''}
          ${hometownFull?detailItem('å‡ºèº«åœ°',escHtml(hometownFull)):''}
          ${p.living?detailItem('ä½ã¾ã„',escHtml(p.living)):''}
          ${p.partner?detailItem('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',escHtml(p.partner)):''}
          ${p.lastcontact?detailItem('æœ€çµ‚é€£çµ¡',`<span class="lc-badge lc-${lastcontactClass(p.lastcontact)}">${escHtml(p.lastcontact)}</span>`):''}
          ${p.insta?`<div class="detail-item"><div class="detail-label">ã‚¤ãƒ³ã‚¹ã‚¿</div><div class="detail-value"><a href="${escHtml(p.insta)}" target="_blank" rel="noopener">Instagram</a></div></div>`:''}
          ${p.memo?`<div class="detail-item full"><div class="detail-label">å‚™è€ƒ</div><div class="detail-value">${escHtml(p.memo)}</div></div>`:''}
        </div>
        ${canEdit?`<div class="card-actions">
          <button class="btn btn-outline btn-sm" onclick="openEditModal('${p.id}')">ç·¨é›†</button>
          <button class="btn btn-danger btn-sm" onclick="askDelete('${p.id}')">å‰Šé™¤</button>
        </div>`:''}
      </div>
    </div>`;
  }).join('');
};

function detailItem(label,value) {
  return `<div class="detail-item"><div class="detail-label">${label}</div><div class="detail-value">${value}</div></div>`;
}

window.toggleCard = (id) => {
  document.getElementById('detail-'+id).classList.toggle('open');
  document.getElementById('chev-'+id).classList.toggle('open');
};

function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ =====
window.openAddModal = () => {
  if (viewingUserId !== currentUser?.uid) { showToast('ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒªã‚¹ãƒˆã«ã¯è¿½åŠ ã§ãã¾ã›ã‚“'); return; }
  editingId = null;
  document.getElementById('modalTitle').textContent = 'æ–°è¦è¿½åŠ ';
  document.getElementById('personForm').reset();
  document.getElementById('f_age').value = '24';
  document.getElementById('f_address').value = 'ç¦å²¡';
  document.getElementById('f_hometown').value = 'ç¦å²¡';
  document.getElementById('editModal').classList.add('open');
  setTimeout(()=>{ document.getElementById('editModal').scrollTop=0; },0);
};

window.openEditModal = (id) => {
  const p = people.find(x=>x.id===id);
  if (!p) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'ç·¨é›†ï¼š'+p.name;
  FIELDS.forEach(f=>{ const el=document.getElementById('f_'+f); if(el) el.value=p[f]||''; });
  document.getElementById('editModal').classList.add('open');
  setTimeout(()=>{ document.getElementById('editModal').scrollTop=0; },0);
};

window.closeEditModal = () => document.getElementById('editModal').classList.remove('open');

window.savePerson = async (e) => {
  e.preventDefault();
  if (!currentUser) return;
  const data = {};
  FIELDS.forEach(f=>{ const el=document.getElementById('f_'+f); data[f]=el?el.value.trim():''; });

  try {
    if (editingId) {
      await updateDoc(doc(db,'users',currentUser.uid,'people',editingId), { ...data, updatedAt: serverTimestamp() });
      showToast('æ›´æ–°ã—ã¾ã—ãŸ');
    } else {
      await addDoc(collection(db,'users',currentUser.uid,'people'), { ...data, createdAt: serverTimestamp() });
      showToast('è¿½åŠ ã—ã¾ã—ãŸ');
    }
    closeEditModal();
  } catch(err) {
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: '+err.message);
  }
};

// ===== å‰Šé™¤ =====
window.askDelete = (id) => {
  const p = people.find(x=>x.id===id);
  if (!p) return;
  deleteTargetId = id;
  document.getElementById('deleteConfirmText').textContent = `ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
  document.getElementById('deleteModal').classList.add('open');
};
window.closeDeleteModal = () => { document.getElementById('deleteModal').classList.remove('open'); deleteTargetId=null; };
window.confirmDelete = async () => {
  if (!deleteTargetId||!currentUser) return;
  try {
    await deleteDoc(doc(db,'users',currentUser.uid,'people',deleteTargetId));
    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e) { showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  closeDeleteModal();
};

// ===== å…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« =====
window.openShareModal = async () => {
  const s = people.length;
  const trust = ['S','A','B','C','D'].map(t=>{ const n=people.filter(p=>p.trust===t).length; return n>0?`${t}:${n}äºº`:null; }).filter(Boolean).join('ã€€');
  document.getElementById('shareStats').textContent = `ç™»éŒ²æ•°ï¼š${s}äººã€€${trust?'ä¿¡ç”¨åº¦ â†’ '+trust:''}`;
  document.getElementById('shareModal').classList.add('open');
  setTimeout(()=>{ document.getElementById('shareModal').scrollTop=0; },0);
  renderShareMemberList();
  loadSharedWithMe();
};
window.closeShareModal = () => document.getElementById('shareModal').classList.remove('open');

// ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
window.exportData = () => {
  const blob = new Blob([JSON.stringify(people,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  const d=new Date();
  a.download=`hotlist_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
};

window.importData = async (e) => {
  if (!currentUser) return;
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported)) throw new Error('å½¢å¼ã‚¨ãƒ©ãƒ¼');
      let count=0;
      for (const p of imported) {
        const data={};
        FIELDS.forEach(f=>{ data[f]=p[f]||''; });
        await addDoc(collection(db,'users',currentUser.uid,'people'),{...data,createdAt:serverTimestamp()});
        count++;
      }
      showToast(`${count}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      closeShareModal();
    } catch(err) { showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šæ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„'); }
    e.target.value='';
  };
  reader.readAsText(file);
};

// ===== å…¨å‰Šé™¤ =====
window.clearAll = async () => {
  if (!currentUser) return;
  if (!confirm('è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  try {
    const snap = await getDocs(collection(db,'users',currentUser.uid,'people'));
    for (const d of snap.docs) await deleteDoc(d.ref);
    showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    closeShareModal();
  } catch(e) { showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
};

// ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
window.confirmSignOut = async () => {
  if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot=null; }
  await signOut(auth);
};

// ===== Toast =====
let toastTimer;
window.showToast = (msg) => {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2400);
};

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ =====
['editModal','shareModal','deleteModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',function(e){
    if(e.target===this){
      if(id==='editModal') closeEditModal();
      else if(id==='shareModal') closeShareModal();
      else if(id==='deleteModal') closeDeleteModal();
    }
  });
});

</script>
</body>
</html>
