<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ›ãƒƒãƒˆãƒªã‚¹ãƒˆ</title>
  <style>
    /* ===== ãƒªã‚»ãƒƒãƒˆ & ãƒ™ãƒ¼ã‚¹ ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #1a73e8;
      --primary-dark: #1557b0;
      --danger: #e53935;
      --success: #43a047;
      --warning: #fb8c00;
      --bg: #f4f6fb;
      --surface: #ffffff;
      --border: #e0e4ef;
      --text: #1e2a3a;
      --text-muted: #6b7a99;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(26,115,232,0.08);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background: var(--primary);
      color: #fff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(26,115,232,0.25);
    }
    header h1 { font-size: 1.15rem; font-weight: 700; letter-spacing: 0.02em; }
    .header-count {
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 2px 10px;
      font-size: 0.8rem;
    }

    /* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ ===== */
    .toolbar {
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .toolbar input[type="text"] {
      flex: 1;
      min-width: 150px;
      padding: 8px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .toolbar input[type="text"]:focus { border-color: var(--primary); }
    .toolbar select {
      padding: 8px 10px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      background: #fff;
      outline: none;
    }

    /* ===== ãƒœã‚¿ãƒ³ ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      white-space: nowrap;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-danger  { background: var(--danger); color: #fff; }
    .btn-outline {
      background: #fff;
      color: var(--primary);
      border: 1.5px solid var(--primary);
    }
    .btn-sm { padding: 5px 10px; font-size: 0.78rem; }
    .btn-icon { padding: 7px; border-radius: 8px; }

    /* ===== ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ ===== */
    .list-container {
      padding: 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .person-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .card-header {
      padding: 12px 14px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .card-info { flex: 1; min-width: 0; }
    .card-name {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .card-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-badges {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 700;
    }
    /* ä¿¡ç”¨åº¦ãƒãƒƒã‚¸ */
    .trust-S { background: #e8f5e9; color: #2e7d32; }
    .trust-A { background: #e3f2fd; color: #1565c0; }
    .trust-B { background: #fff8e1; color: #f57f17; }
    .trust-C { background: #fce4ec; color: #c62828; }
    .trust-D { background: #eeeeee; color: #616161; }
    /* ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ */
    .type-P { background: #fce4ec; color: #ad1457; }
    .type-C { background: #e8eaf6; color: #283593; }
    .type-A { background: #e0f2f1; color: #00695c; }
    .type-S { background: #fff3e0; color: #e65100; }

    /* ç«‹å ´ã‚¢ã‚¤ã‚³ãƒ³ */
    .position-badge {
      font-size: 1rem;
      line-height: 1;
    }

    /* ã‚«ãƒ¼ãƒ‰è©³ç´°ï¼ˆå±•é–‹ï¼‰ */
    .card-detail {
      display: none;
      padding: 0 14px 14px;
      border-top: 1px solid var(--border);
    }
    .card-detail.open { display: block; }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .detail-item { }
    .detail-item.full { grid-column: 1 / -1; }
    .detail-label {
      font-size: 0.68rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 2px;
    }
    .detail-value {
      font-size: 0.88rem;
      font-weight: 500;
      word-break: break-all;
    }
    .detail-value a {
      color: var(--primary);
      text-decoration: none;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .chevron {
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .chevron.open { transform: rotate(180deg); }

    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      overflow-y: auto;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; align-items: flex-start; justify-content: center; }
    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      width: 100%;
      max-width: 520px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      margin: auto;
    }
    .modal-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      line-height: 1;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group.full { grid-column: 1 / -1; }
    label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      background: #fff;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    textarea { resize: vertical; min-height: 70px; }
    .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* ===== ç©ºçŠ¶æ…‹ ===== */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.9rem; margin-top: 6px; }

    /* ===== ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆFABï¼‰ ===== */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 1.6rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(26,115,232,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 90;
      transition: transform 0.15s;
    }
    .fab:active { transform: scale(0.93); }

    /* ===== å…±æœ‰ãƒ‘ãƒãƒ« ===== */
    .share-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1e2a3a;
      color: #fff;
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 0.85rem;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.25s, transform 0.25s;
      white-space: nowrap;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
    @media (max-width: 400px) {
      .form-grid { grid-template-columns: 1fr; }
      .detail-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: 1; }
    }
  </style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header>
  <h1>ğŸ”¥ ãƒ›ãƒƒãƒˆãƒªã‚¹ãƒˆ</h1>
  <span class="header-count" id="countBadge">0äºº</span>
</header>

<!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
<div class="toolbar">
  <input type="text" id="searchInput" placeholder="ğŸ” åå‰ãƒ»ä»•äº‹ãƒ»é–¢ä¿‚æ€§ã§æ¤œç´¢" oninput="renderList()">
  <select id="filterTrust" onchange="renderList()">
    <option value="">ä¿¡ç”¨åº¦ å…¨ã¦</option>
    <option value="S">S ãƒ©ãƒ³ã‚¯</option>
    <option value="A">A ãƒ©ãƒ³ã‚¯</option>
    <option value="B">B ãƒ©ãƒ³ã‚¯</option>
    <option value="C">C ãƒ©ãƒ³ã‚¯</option>
    <option value="D">D ãƒ©ãƒ³ã‚¯</option>
  </select>
  <select id="filterType" onchange="renderList()">
    <option value="">ã‚¿ã‚¤ãƒ— å…¨ã¦</option>
    <option value="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼</option>
    <option value="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</option>
    <option value="ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼">ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</option>
    <option value="ã‚µãƒãƒ¼ã‚¿ãƒ¼">ã‚µãƒãƒ¼ã‚¿ãƒ¼</option>
  </select>
  <button class="btn btn-outline btn-sm" onclick="openShareModal()">ğŸ“¤ å…±æœ‰</button>
</div>

<!-- ãƒªã‚¹ãƒˆ -->
<div class="list-container" id="listContainer"></div>

<!-- FAB -->
<button class="fab" onclick="openAddModal()" title="è¿½åŠ ">ï¼‹</button>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ===== è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">
      <span id="modalTitle">æ–°è¦è¿½åŠ </span>
      <button class="modal-close" onclick="closeEditModal()">âœ•</button>
    </div>
    <form id="personForm" onsubmit="savePerson(event)">
      <div class="form-grid">

        <div class="form-group full">
          <label>åå‰ *</label>
          <input type="text" id="f_name" required placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
        </div>

        <div class="form-group">
          <label>å¹´é½¢</label>
          <input type="number" id="f_age" placeholder="ä¾‹ï¼š28" min="0" max="120">
        </div>

        <div class="form-group">
          <label>æ€§åˆ¥</label>
          <select id="f_gender">
            <option value="">-</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <div class="form-group full">
          <label>ã‚¤ãƒ³ã‚¹ã‚¿ URL</label>
          <input type="url" id="f_insta" placeholder="https://www.instagram.com/...">
        </div>

        <div class="form-group full">
          <label>é–¢ä¿‚æ€§</label>
          <input type="text" id="f_relation" placeholder="ä¾‹ï¼šä¸­å­¦ã®é‡çƒéƒ¨ã®åŒç´šç”Ÿ">
        </div>

        <div class="form-group full">
          <label>ä»•äº‹ï¼ˆç¤¾åï¼‰</label>
          <input type="text" id="f_job" placeholder="ä¾‹ï¼šå–¶æ¥­ / æ ªå¼ä¼šç¤¾ã€‡ã€‡">
        </div>

        <div class="form-group">
          <label>ä¿¡ç”¨åº¦</label>
          <select id="f_trust">
            <option value="">-</option>
            <option value="S">Sï¼ˆ100%ï¼‰</option>
            <option value="A">Aï¼ˆ80%ä»¥ä¸Šï¼‰</option>
            <option value="B">Bï¼ˆ50%ä»¥ä¸Šï¼‰</option>
            <option value="C">Cï¼ˆãã‚Œä»¥ä¸‹ï¼‰</option>
            <option value="D">Dï¼ˆå…¨ããªã—ï¼‰</option>
          </select>
        </div>

        <div class="form-group">
          <label>ç«‹å ´</label>
          <select id="f_position">
            <option value="">-</option>
            <option value="â†‘">â†‘ è‡ªåˆ†ãŒä¸Š</option>
            <option value="â†“">â†“ è‡ªåˆ†ãŒä¸‹</option>
            <option value="ãƒ¼">ãƒ¼ åŒã˜</option>
          </select>
        </div>

        <div class="form-group full">
          <label>ãƒ‹ãƒ¼ã‚º</label>
          <input type="text" id="f_needs" placeholder="ä¾‹ï¼šãŠé‡‘ã‚’ç¨¼ããŸã„ã€ä»•äº‹ã‚’è¾ã‚ãŸã„">
        </div>

        <div class="form-group">
          <label>ç¾ä½æ‰€</label>
          <input type="text" id="f_address" placeholder="ä¾‹ï¼šç¦å²¡å¸‚">
        </div>

        <div class="form-group">
          <label>å‡ºèº«åœ°</label>
          <input type="text" id="f_hometown" placeholder="ä¾‹ï¼šç­‘ç´«é‡å¸‚">
        </div>

        <div class="form-group">
          <label>ä½ã¾ã„</label>
          <select id="f_living">
            <option value="">-</option>
            <option value="ä¸€äººæš®ã‚‰ã—">ä¸€äººæš®ã‚‰ã—</option>
            <option value="å®Ÿå®¶">å®Ÿå®¶</option>
            <option value="åŒæ£²">åŒæ£²</option>
            <option value="åŠåŒæ£²">åŠåŒæ£²</option>
            <option value="ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹">ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹</option>
          </select>
        </div>

        <div class="form-group">
          <label>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</label>
          <select id="f_partner">
            <option value="">-</option>
            <option value="æœ‰ã‚Š">æœ‰ã‚Š</option>
            <option value="ç„¡ã—">ç„¡ã—</option>
            <option value="çµå©š">çµå©š</option>
            <option value="å­ä¾›ã‚ã‚Š">å­ä¾›ã‚ã‚Š</option>
          </select>
        </div>

        <div class="form-group full">
          <label>ï¼”ã¤ã®ã‚¿ã‚¤ãƒ—</label>
          <select id="f_type">
            <option value="">-</option>
            <option value="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼</option>
            <option value="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</option>
            <option value="ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼">ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</option>
            <option value="ã‚µãƒãƒ¼ã‚¿ãƒ¼">ã‚µãƒãƒ¼ã‚¿ãƒ¼</option>
          </select>
        </div>

        <div class="form-group full">
          <label>å‚™è€ƒ</label>
          <textarea id="f_memo" placeholder="è‡ªç”±è¨˜è¿°"></textarea>
        </div>

      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-outline" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== å…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
<div class="modal-overlay" id="shareModal">
  <div class="modal">
    <div class="modal-title">
      <span>ãƒ‡ãƒ¼ã‚¿ã®å…±æœ‰ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
      <button class="modal-close" onclick="closeShareModal()">âœ•</button>
    </div>
    <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
      JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ä»–ã®ç«¯æœ«ãƒ»ãƒ¡ãƒ³ãƒãƒ¼ã¨å…±æœ‰ã§ãã¾ã™ã€‚<br>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«<strong>è¿½åŠ </strong>ã•ã‚Œã¾ã™ã€‚
    </p>
    <div class="share-actions">
      <button class="btn btn-primary" onclick="exportData()">ğŸ“¥ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label class="btn btn-outline" style="cursor:pointer;">
        ğŸ“¤ JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        <input type="file" accept=".json" style="display:none" onchange="importData(event)">
      </label>
      <button class="btn btn-danger btn-sm" onclick="clearAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>
    <div id="shareStats" style="margin-top:14px;font-size:0.83rem;color:var(--text-muted);"></div>
  </div>
</div>

<!-- ===== å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <div class="modal-title">å‰Šé™¤ã®ç¢ºèª</div>
    <p id="deleteConfirmText" style="font-size:0.9rem;margin-bottom:16px;"></p>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
// ===== ãƒ‡ãƒ¼ã‚¿ç®¡ç† =====
let people = JSON.parse(localStorage.getItem('hotlist_v1') || '[]');
let editingId = null;
let deleteTargetId = null;

function save() {
  localStorage.setItem('hotlist_v1', JSON.stringify(people));
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

// ===== ã‚«ãƒ©ãƒ¼ï¼ˆã‚¢ãƒã‚¿ãƒ¼ç”¨ï¼‰ =====
const COLORS = ['#e53935','#d81b60','#8e24aa','#5e35b1','#1e88e5','#00897b','#43a047','#f57c00','#6d4c41'];
function getColor(name) {
  let h = 0;
  for (let c of (name || 'A')) h = (h * 31 + c.charCodeAt(0)) % COLORS.length;
  return COLORS[h];
}

// ===== ã‚¿ã‚¤ãƒ—ç•¥ç§° =====
const TYPE_SHORT = { 'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼': 'P', 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼': 'C', 'ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼': 'A', 'ã‚µãƒãƒ¼ã‚¿ãƒ¼': 'S' };

// ===== ç«‹å ´è¡¨ç¤º =====
function positionLabel(p) {
  if (p === 'â†‘') return '<span title="è‡ªåˆ†ãŒä¸Š">â¬†ï¸</span>';
  if (p === 'â†“') return '<span title="è‡ªåˆ†ãŒä¸‹">â¬‡ï¸</span>';
  if (p === 'ãƒ¼') return '<span title="åŒã˜">â¡ï¸</span>';
  return '';
}

// ===== ãƒªã‚¹ãƒˆæç”» =====
function renderList() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const ft = document.getElementById('filterTrust').value;
  const ftp = document.getElementById('filterType').value;

  const filtered = people.filter(p => {
    const matchQ = !q || [p.name, p.job, p.relation, p.needs, p.address, p.memo]
      .some(v => (v||'').toLowerCase().includes(q));
    const matchT = !ft || p.trust === ft;
    const matchTP = !ftp || p.type === ftp;
    return matchQ && matchT && matchTP;
  });

  document.getElementById('countBadge').textContent = `${filtered.length}äºº`;
  const container = document.getElementById('listContainer');

  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <strong>${people.length === 0 ? 'ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“' : 'è©²å½“è€…ãªã—'}</strong>
        <p>${people.length === 0 ? 'å³ä¸‹ã® ï¼‹ ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„' : 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚„æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„'}</p>
      </div>`;
    return;
  }

  container.innerHTML = filtered.map(p => {
    const initial = (p.name||'?')[0];
    const color = getColor(p.name);
    const typeShort = TYPE_SHORT[p.type] || '';
    const typeCls = typeShort ? `type-${typeShort}` : '';
    return `
    <div class="person-card" id="card-${p.id}">
      <div class="card-header" onclick="toggleCard('${p.id}')">
        <div class="avatar" style="background:${color}">${initial}</div>
        <div class="card-info">
          <div class="card-name">
            ${escHtml(p.name)}
            ${p.position ? `<span class="position-badge">${positionLabel(p.position)}</span>` : ''}
          </div>
          <div class="card-sub">${[p.age ? p.age+'æ­³' : '', p.gender, p.job].filter(Boolean).join(' Â· ')}</div>
          <div class="card-sub">${p.relation || ''}</div>
        </div>
        <div class="card-badges">
          ${p.trust ? `<span class="badge trust-${p.trust}">${p.trust}ãƒ©ãƒ³ã‚¯</span>` : ''}
          ${typeShort ? `<span class="badge ${typeCls}">${p.type}</span>` : ''}
          <span class="chevron" id="chev-${p.id}">â–¼</span>
        </div>
      </div>
      <div class="card-detail" id="detail-${p.id}">
        <div class="detail-grid">
          ${p.needs ? detailItem('ãƒ‹ãƒ¼ã‚º', escHtml(p.needs)) : ''}
          ${p.address ? detailItem('ç¾ä½æ‰€', escHtml(p.address)) : ''}
          ${p.hometown ? detailItem('å‡ºèº«åœ°', escHtml(p.hometown)) : ''}
          ${p.living ? detailItem('ä½ã¾ã„', escHtml(p.living)) : ''}
          ${p.partner ? detailItem('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', escHtml(p.partner)) : ''}
          ${p.insta ? `<div class="detail-item"><div class="detail-label">ã‚¤ãƒ³ã‚¹ã‚¿</div><div class="detail-value"><a href="${escHtml(p.insta)}" target="_blank" rel="noopener">ğŸ”— ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a></div></div>` : ''}
          ${p.memo ? `<div class="detail-item full">${detailItemRaw('å‚™è€ƒ', escHtml(p.memo))}</div>` : ''}
        </div>
        <div class="card-actions">
          <button class="btn btn-outline btn-sm" onclick="openEditModal('${p.id}')">âœï¸ ç·¨é›†</button>
          <button class="btn btn-danger btn-sm" onclick="askDelete('${p.id}')">ğŸ—‘ å‰Šé™¤</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function detailItem(label, value) {
  return `<div class="detail-item"><div class="detail-label">${label}</div><div class="detail-value">${value}</div></div>`;
}
function detailItemRaw(label, value) {
  return `<div class="detail-label">${label}</div><div class="detail-value">${value}</div>`;
}

function toggleCard(id) {
  const detail = document.getElementById('detail-' + id);
  const chev   = document.getElementById('chev-' + id);
  detail.classList.toggle('open');
  chev.classList.toggle('open');
}

function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ =====
function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'æ–°è¦è¿½åŠ ';
  document.getElementById('personForm').reset();
  document.getElementById('editModal').classList.add('open');
}

function openEditModal(id) {
  const p = people.find(x => x.id === id);
  if (!p) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'ç·¨é›†ï¼š' + p.name;
  const fields = ['name','age','gender','insta','relation','job','trust','position','needs','address','hometown','living','partner','type','memo'];
  fields.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = p[f] || '';
  });
  document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
}

function savePerson(e) {
  e.preventDefault();
  const fields = ['name','age','gender','insta','relation','job','trust','position','needs','address','hometown','living','partner','type','memo'];
  const data = {};
  fields.forEach(f => {
    const el = document.getElementById('f_' + f);
    data[f] = el ? el.value.trim() : '';
  });

  if (editingId) {
    const idx = people.findIndex(x => x.id === editingId);
    if (idx !== -1) people[idx] = { ...people[idx], ...data };
  } else {
    data.id = generateId();
    data.createdAt = new Date().toISOString();
    people.unshift(data);
  }
  save();
  closeEditModal();
  renderList();
  showToast(editingId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'è¿½åŠ ã—ã¾ã—ãŸ âœ“');
}

// ===== å‰Šé™¤ =====
function askDelete(id) {
  const p = people.find(x => x.id === id);
  if (!p) return;
  deleteTargetId = id;
  document.getElementById('deleteConfirmText').textContent = `ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
  document.getElementById('deleteModal').classList.add('open');
}
function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('open');
  deleteTargetId = null;
}
function confirmDelete() {
  if (!deleteTargetId) return;
  people = people.filter(x => x.id !== deleteTargetId);
  save();
  renderList();
  closeDeleteModal();
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===== å…±æœ‰ =====
function openShareModal() {
  const stats = document.getElementById('shareStats');
  const s = people.length;
  const trust = ['S','A','B','C','D'].map(t => {
    const n = people.filter(p => p.trust === t).length;
    return n > 0 ? `${t}:${n}äºº` : null;
  }).filter(Boolean).join('ã€€');
  stats.textContent = `ç™»éŒ²æ•°ï¼š${s}äººã€€${trust ? 'ä¿¡ç”¨åº¦ â†’ ' + trust : ''}`;
  document.getElementById('shareModal').classList.add('open');
}
function closeShareModal() {
  document.getElementById('shareModal').classList.remove('open');
}

function exportData() {
  const blob = new Blob([JSON.stringify(people, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const d = new Date();
  a.download = `hotlist_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported)) throw new Error('å½¢å¼ã‚¨ãƒ©ãƒ¼');
      // é‡è¤‡IDã‚’é™¤ã„ã¦è¿½åŠ 
      const existingIds = new Set(people.map(p => p.id));
      const toAdd = imported.filter(p => p.id && !existingIds.has(p.id));
      people = [...toAdd, ...people];
      save();
      renderList();
      closeShareModal();
      showToast(`${toAdd.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    } catch {
      showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šæ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„');
    }
    e.target.value = '';
  };
  reader.readAsText(file);
}

function clearAll() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  people = [];
  save();
  renderList();
  closeShareModal();
  showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===== Toast =====
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ =====
['editModal','shareModal','deleteModal'].forEach(id => {
  document.getElementById(id).addEventListener('click', function(e) {
    if (e.target === this) {
      if (id === 'editModal') closeEditModal();
      else if (id === 'shareModal') closeShareModal();
      else if (id === 'deleteModal') closeDeleteModal();
    }
  });
});

// ===== åˆæœŸæç”» =====
renderList();
</script>
</body>
</html>
